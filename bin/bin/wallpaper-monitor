#!/bin/bash

while true; do
    localDir=(~/.wallpaper/*)

    screenInfo=$(xrandr | grep 'Screen 0')
    screenWidth=$(echo ${screenInfo} | awk '{print $8}')
    screenHeight=$(echo ${screenInfo} | awk '{print $10}' | tr -d ",")

    internetState=$(ping -c 1 -w 1 8.8.8.8 > /dev/null && echo 1 || echo 0)
    activeWorkspace=$(i3-msg -t get_workspaces | jq '.[] | select(.focused).name')
    windowsOpen=$(i3-msg -t get_tree | jq '(.nodes[].nodes[].nodes[] | select(.type=="workspace") | select(.name=='${activeWorkspace}') | .nodes | length) // 0')

    # Fetch a wallpaper if none exists
    if [[ ! -e /tmp/bgnormal.jpg ]]; then

        # Fetch a random wallpaper from reddit if connected to the internet
        if [[ ${internetState} -eq 1 ]]; then
            randomSub=$(echo $[ 1 + $[ RANDOM % 4 ]])

            if [[ ${randomSub} -eq 1 ]]; then
                subName="Wallpapers"
            elif [[ ${randomSub} -eq 2 ]]; then
                subName="EarthPorn"
            elif [[ ${randomSub} -eq 3 ]]; then
                subName="SummerPorn"
            elif [[ ${randomSub} -eq 4 ]]; then
                subName="ExposurePorn"
            fi

            wget -O - http://www.reddit.com/r/${subName} | grep -Eo 'http://i.imgur.com[^&]+jpg' | shuf -n 1 | xargs wget -O /tmp/bgnormal.jpg

            imageInfo=$(identify /tmp/bgnormal.jpg | awk '{print $3}' | tr "x" " ")
            imageWidth=$(echo ${imageInfo} | awk '{print $1}')
            imageHeight=$(echo ${imageInfo} | awk '{print $2}')

            # Fetch a different wallpaper if the current one is smaller than the main screen's resolution
            if [[ ${imageWidth} -lt ${screenWidth} || ${imageHeight} -lt ${screenHeight} ]]; then
                rm /tmp/bgnormal.jpg /tmp/bgblurred.jpg
            else
                echo "/r/${subName}" > /tmp/bgsource
            fi

        # Fetch a random wallpaper from the specified local directory if not connected to the internet
        else
            cp $(printf "%s\n" "${localDir[RANDOM % ${#localDir[@]}]}") /tmp/bgnormal.jpg
            echo "local directory" > /tmp/bgsource
        fi
    fi

    # Created a blurred version of the wallpaper if one does not exist, then popup a notification showing where the wallpaper originated.
    if [[ ! -e /tmp/bgblurred.jpg && -e /tmp/bgnormal.jpg ]]; then
        convert /tmp/bgnormal.jpg -channel RGBA -blur 0x15 -alpha off /tmp/bgblurred.jpg
        ~/.config/lemonbar/popup-spawner $(echo "Wallpaper loaded from $(cat /tmp/bgsource).")
    fi

    # If a window is open, display the blurred version of the wallpaper
    if [ ${windowsOpen} -eq 0 ]; then
    	feh --bg-fill /tmp/bgnormal.jpg
    else
    	feh --bg-fill /tmp/bgblurred.jpg
    fi
done
